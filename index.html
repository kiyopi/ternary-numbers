<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座標キューヲメンデ変換プロトタイプ (フェーズ3)</title>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #121212; color: #e0e0e0; overflow: hidden; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-panel { position: absolute; top: 20px; left: 20px; background-color: rgba(30, 30, 30, 0.85); padding: 20px; border-radius: 8px; border-left: 5px solid #bb86fc; width: 340px; display: flex; flex-direction: column; gap: 15px; }
        h1, h2 { margin-top: 0; color: #bb86fc; font-size: 1.2em; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .emotion-btn, .tengu-btn, .view-btn { padding: 10px; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; background-color: #333; color: #eee;}
        .emotion-btn:hover, .tengu-btn:hover, .view-btn:hover { transform: scale(1.05); }
        #joy-btn { background-color: #ff4444; color: white; }
        #anger-btn { background-color: #ffff00; color: black; }
        #sad-btn { background-color: #4488ff; color: white; }
        #fun-btn { background-color: #555; color: white; }
        .tengu-btn.active { background-color: #03dac6; color: black; border-color: #03dac6; }
        .info-section { background-color: #2a2a2a; padding: 15px; border-radius: 4px; }
        .info-item { margin-bottom: 12px; }
        .info-item:last-child { margin-bottom: 0; }
        .info-item label { font-weight: bold; color: #03dac6; display: block; font-size: 0.9em;}
        .info-item span { font-size: 1.1em; min-height: 1.2em; display: inline-block; }
        #angle-highlight { position: absolute; top: 20px; right: 20px; background-color: rgba(207, 102, 121, 0.9); padding: 10px 15px; border-radius: 4px; font-size: 1.1em; color: white; transition: opacity 0.5s; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="canvas-container"><canvas id="three-canvas"></canvas></div>
    <div id="ui-panel">
        <section>
            <h1>感情選択</h1>
            <div class="button-group">
                <button id="joy-btn" class="emotion-btn">喜 (Joy)</button>
                <button id="anger-btn" class="emotion-btn">怒 (Anger)</button>
                <button id="sad-btn" class="emotion-btn">哀 (Sad)</button>
                <button id="fun-btn" class="emotion-btn">楽 (Fun)</button>
            </div>
        </section>
        <section>
            <h2>B. 認知三軸 (Tengu)</h2>
            <div class="button-group">
                <button id="x-tengu-btn" class="tengu-btn">X-tengu</button>
                <button id="y-tengu-btn" class="tengu-btn">Y-tengu</button>
                <button id="z-tengu-btn" class="tengu-btn">Z-tengu</button>
                <button id="free-btn" class="tengu-btn active">Free</button>
            </div>
        </section>
        <section>
            <h2>C. 観測者の立ち位置 (苔tengu)</h2>
            <div class="button-group">
                 <button id="nimou-btn" class="view-btn">二芒星視点</button>
                 <button id="sanmou-btn" class="view-btn">三芒星視点</button>
            </div>
        </section>
        <div class="info-section">
            <div class="info-item"><label>選択された感情:</label><span id="info-emotion">未選択</span></div>
            <div class="info-item"><label>使用中の認知軸:</label><span id="info-axis">Free</span></div>
            <div class="info-item"><label>現在の視点角度 (方位角 / 仰角):</label><span id="info-angle">---</span></div>
            <div class="info-item"><label>A. この角度での感情の解釈:</label><span id="info-interpretation">---</span></div>
            <div class="info-item"><label>30進数乗数回転 (思考ループ):</label><span id="rotation-animation">---</span></div>
        </div>
    </div>
    <div id="angle-highlight"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const EMOTIONS = {
            JOY:   { name: '喜', overtone: 15, color: 0xff4444 }, ANGER: { name: '怒', overtone: 5,  color: 0xffff00 },
            SAD:   { name: '哀', overtone: 3,  color: 0x4488ff }, FUN:   { name: '楽', overtone: 9,  color: 0x555555 }
        };
        const INTERPRETATION_MAP = {
            JOY:   { 0: "陽性エネルギー", 90: "統合が必要な要素 (15倍音)" },
            ANGER: { 90: "衝動/運動神経 (5倍音)", 270: "社会的都合 (認知の偏り)" },
            SAD:   { 180: "収縮/孤独感", 270: "内省的状態" },
            FUN:   { 0: "広がり (平面)、感動", 180: "潜伏的な力 (マールススィン)" }
        };
        let currentEmotionKey = null;

        const uiElements = {
            canvas: document.getElementById('three-canvas'), joyBtn: document.getElementById('joy-btn'), angerBtn: document.getElementById('anger-btn'), sadBtn: document.getElementById('sad-btn'), funBtn: document.getElementById('fun-btn'),
            xtenguBtn: document.getElementById('x-tengu-btn'), ytenguBtn: document.getElementById('y-tengu-btn'), ztenguBtn: document.getElementById('z-tengu-btn'), freeBtn: document.getElementById('free-btn'),
            nimouBtn: document.getElementById('nimou-btn'), sanmouBtn: document.getElementById('sanmou-btn'),
            infoEmotion: document.getElementById('info-emotion'), infoAngle: document.getElementById('info-angle'), infoAxis: document.getElementById('info-axis'), infoInterpretation: document.getElementById('info-interpretation'),
            rotationAnimationSpan: document.getElementById('rotation-animation'), angleHighlightDiv: document.getElementById('angle-highlight')
        };
        const tenguButtons = [uiElements.xtenguBtn, uiElements.ytenguBtn, uiElements.ztenguBtn, uiElements.freeBtn];

        let scene, camera, renderer, controls, mainObject, rotationInterval, isDistorting = false, distortionTimer;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x121212);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            renderer = new THREE.WebGLRenderer({ canvas: uiElements.canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(3, 5, 4);
            scene.add(directionalLight);
            
            const geometry = new THREE.IcosahedronGeometry(1.5, 1);
            mainObject = new THREE.Mesh(geometry, new THREE.MeshPhongMaterial({ color: 0xaaaaaa, shininess: 50 }));
            scene.add(mainObject);

            setupEventListeners();
            animate();
        }

        function setupEventListeners() {
            uiElements.joyBtn.addEventListener('click', () => selectEmotion(EMOTIONS.JOY, 'JOY'));
            uiElements.angerBtn.addEventListener('click', () => selectEmotion(EMOTIONS.ANGER, 'ANGER'));
            uiElements.sadBtn.addEventListener('click', () => selectEmotion(EMOTIONS.SAD, 'SAD'));
            uiElements.funBtn.addEventListener('click', () => selectEmotion(EMOTIONS.FUN, 'FUN'));
            
            uiElements.xtenguBtn.addEventListener('click', () => setActiveAxis('X'));
            uiElements.ytenguBtn.addEventListener('click', () => setActiveAxis('Y'));
            uiElements.ztenguBtn.addEventListener('click', () => setActiveAxis('Z'));
            uiElements.freeBtn.addEventListener('click', () => setActiveAxis('Free'));

            uiElements.nimouBtn.addEventListener('click', () => snapToViewpoint(new THREE.Vector3(5, 5, 5)));
            uiElements.sanmouBtn.addEventListener('click', () => snapToViewpoint(new THREE.Vector3(-5, 3, 5)));

            controls.addEventListener('change', () => {
                if (!isDistorting) {
                    isDistorting = true;
                    if(distortionTimer) clearTimeout(distortionTimer);
                    distortionTimer = setTimeout(() => { isDistorting = false; }, 150);
                }
            });
            window.addEventListener('resize', onWindowResize);
        }

        function calculate_30_remainder(N, i) { return (N ** i) % 30; }

        function selectEmotion(emotion, key) {
            currentEmotionKey = key;
            mainObject.material.color.set(emotion.color);
            uiElements.infoEmotion.textContent = emotion.name;
            mainObject.rotation.set(0.1, 0.2, 0);
            if (rotationInterval) clearInterval(rotationInterval);
            let i = 1, sequence = [];
            rotationInterval = setInterval(() => {
                if (i > 4) { i = 1; sequence = []; }
                const remainder = calculate_30_remainder(emotion.overtone, i);
                sequence.push(`${remainder}°`);
                uiElements.rotationAnimationSpan.textContent = sequence.join(' → ');
                mainObject.material.emissive.set(emotion.color);
                setTimeout(() => { mainObject.material.emissive.set(0x000000); }, 200);
                i++;
            }, 800);
        }

        function setActiveAxis(axis) {
            controls.minAzimuthAngle = -Infinity; controls.maxAzimuthAngle = Infinity;
            controls.minPolarAngle = 0; controls.maxPolarAngle = Math.PI;
            controls.enableZoom = true; controls.enablePan = true;

            if (axis === 'X') { controls.minPolarAngle = Math.PI / 2; controls.maxPolarAngle = Math.PI / 2; }
            if (axis === 'Y') { controls.minAzimuthAngle = 0; controls.maxAzimuthAngle = 0; }
            if (axis === 'Z') { controls.enableZoom = false; controls.enablePan = false; controls.minPolarAngle = Math.PI / 2; controls.maxPolarAngle = Math.PI / 2; controls.minAzimuthAngle = 0; controls.maxAzimuthAngle = 0; }
            
            uiElements.infoAxis.textContent = axis;
            tenguButtons.forEach(btn => btn.classList.remove('active'));
            // ▼▼▼【修正点】この一行に構文エラーがありました ▼▼▼
            const buttonId = (axis === 'Free') ? 'free-btn' : `${axis.toLowerCase()}-tengu-btn`;
            document.getElementById(buttonId).classList.add('active');
        }

        function snapToViewpoint(targetPosition) {
            const start = camera.position.clone();
            let alpha = 0;
            function animateSnap() {
                alpha += 0.05;
                if (alpha > 1) alpha = 1;
                camera.position.lerpVectors(start, targetPosition, alpha);
                if (alpha < 1) requestAnimationFrame(animateSnap);
            }
            animateSnap();
        }

        let highlightTimer;
        function showHighlight(message, duration = 1000) {
            uiElements.angleHighlightDiv.textContent = message;
            uiElements.angleHighlightDiv.style.opacity = '1';
            if (highlightTimer) clearTimeout(highlightTimer);
            highlightTimer = setTimeout(() => { uiElements.angleHighlightDiv.style.opacity = '0'; }, duration);
        }

        function updateInfoPanel() {
            const pos = camera.position;
            const azimuth = (Math.atan2(pos.x, pos.z) * (180 / Math.PI) + 360) % 360;
            const polar = Math.acos(pos.y / pos.length()) * (180 / Math.PI);
            uiElements.infoAngle.textContent = `${azimuth.toFixed(1)}° / ${polar.toFixed(1)}°`;

            let interpretationText = "---";
            if (currentEmotionKey && INTERPRETATION_MAP[currentEmotionKey]) {
                const interpretations = INTERPRETATION_MAP[currentEmotionKey];
                let found = false;
                for (const angle in interpretations) {
                    if (Math.abs(azimuth - parseInt(angle)) < 10) {
                        interpretationText = interpretations[angle];
                        found = true;
                        break;
                    }
                }
                if (!found) uiElements.infoInterpretation.textContent = "---";
                else uiElements.infoInterpretation.textContent = interpretationText;
            } else {
                uiElements.infoInterpretation.textContent = "---";
            }

            const proximity = 5;
            if (Math.abs(azimuth - 90) < proximity || Math.abs(azimuth - 270) < proximity) {
                showHighlight("90°の倍数：認知と空間の基礎単位", 1500);
            } else if (azimuth > proximity && Math.abs(azimuth-360) > proximity && (azimuth % 30 < proximity || Math.abs(azimuth % 30 - 30) < proximity)) {
                showHighlight("30°の倍数：物質の基礎単位");
            }
        }
        
        function applyDistortion() {
             if (isDistorting) {
                const time = Date.now() * 0.01;
                mainObject.scale.x = 1 + Math.sin(time) * 0.02;
                mainObject.scale.y = 1 + Math.cos(time) * 0.02;
            } else { mainObject.scale.set(1, 1, 1); }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateInfoPanel();
            applyDistortion();
            renderer.render(scene, camera);
        }
        
        init();
    </script>
</body>
</html>