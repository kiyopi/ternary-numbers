<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座標キューヲメンデ変換プロトタイプ (最終版 + データ出力)</title>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #121212; color: #e0e0e0; overflow: hidden; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-panel { position: absolute; top: 20px; left: 20px; background-color: rgba(30, 30, 30, 0.85); padding: 20px; border-radius: 8px; border-left: 5px solid #bb86fc; width: 340px; display: flex; flex-direction: column; gap: 15px; max-height: calc(100vh - 40px); overflow-y: auto;}
        h1, h2 { margin-top: 0; color: #bb86fc; font-size: 1.2em; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 10px; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; background-color: #333; color: #eee;}
        .btn:hover { transform: scale(1.05); }
        #joy-btn { background-color: #ff4444; color: white; }
        #anger-btn { background-color: #ffff00; color: black; }
        #sad-btn { background-color: #4488ff; color: white; }
        #fun-btn { background-color: #555; color: white; }
        .info-section { background-color: #2a2a2a; padding: 15px; border-radius: 4px; }
        .info-item { margin-bottom: 12px; }
        .info-item:last-child { margin-bottom: 0; }
        .info-item label { font-weight: bold; color: #03dac6; display: block; font-size: 0.9em;}
        .info-item span, .json-display { font-size: 1.1em; min-height: 1.2em; display: block; word-wrap: break-word; }
        .json-display { font-family: 'Courier New', Courier, monospace; line-height: 1.4; font-size: 0.9em; white-space: pre; }
        #arrow-display { text-align: center; }
        .dots { margin-bottom: 5px; }
        .dot { display: inline-block; width: 15px; height: 15px; border-radius: 50%; margin: 0 3px; border: 1px solid #888;}
        .arrow-symbol { font-size: 2em; font-weight: bold; }
    </style>
</head>
<body>
    <div id="canvas-container"><canvas id="three-canvas"></canvas></div>
    <div id="ui-panel">
        <section>
            <h1>感情選択</h1>
            <div class="button-group">
                <button id="joy-btn" class="emotion-btn">喜 (Joy)</button>
                <button id="anger-btn" class="emotion-btn">怒 (Anger)</button>
                <button id="sad-btn" class="emotion-btn">哀 (Sad)</button>
                <button id="fun-btn" class="emotion-btn">楽 (Fun)</button>
            </div>
        </section>
        <div class="info-section">
            <div class="info-item"><label>選択された感情:</label><span id="info-emotion">未選択</span></div>
            <div class="info-item"><label>現在の視点角度 (方位角):</label><span id="info-angle">---</span></div>
        </div>
        <div class="info-section">
            <h2>3進数データ</h2>
            <div class="info-item">
                <label>JSON形式:</label>
                <div id="json-output" class="json-display">{ ... }</div>
            </div>
             <div class="info-item">
                <label>該当する矢印:</label>
                <div id="arrow-display">
                    <div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    <div class="arrow-symbol">--</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- 基礎データ定義 ---
        const EMOTIONS = {
            JOY:   { name: '喜', overtone: 15, color: 'red' },
            ANGER: { name: '怒', overtone: 5,  color: 'yellow' },
            SAD:   { name: '哀', overtone: 3,  color: 'blue' },
            FUN:   { name: '楽', overtone: 9,  color: 'black' }
        };

        // 矢印の定義（色でマッピング）
        const ARROWS = {
            red:    { symbol: 'V', dots: ['red', 'blue', 'red'] },
            // 注: 図に黄色がないため、最も赤に近い構成の矢印を「怒」に対応させます
            yellow: { symbol: 'V', dots: ['black', 'red', 'red'] },
            blue:   { symbol: 'V', dots: ['blue', 'blue', 'blue'] },
            black:  { symbol: 'V', dots: ['black', 'black', 'black'] }
        };
        let currentEmotionKey = null;

        // --- UI要素 ---
        const uiElements = {
            canvas: document.getElementById('three-canvas'),
            joyBtn: document.getElementById('joy-btn'), angerBtn: document.getElementById('anger-btn'),
            sadBtn: document.getElementById('sad-btn'), funBtn: document.getElementById('fun-btn'),
            infoEmotion: document.getElementById('info-emotion'), infoAngle: document.getElementById('info-angle'),
            jsonOutput: document.getElementById('json-output'), arrowDisplay: document.getElementById('arrow-display')
        };
        
        let scene, camera, renderer, controls, mainObject;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x121212);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            renderer = new THREE.WebGLRenderer({ canvas: uiElements.canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(3, 5, 4);
            scene.add(directionalLight);
            
            const geometry = new THREE.IcosahedronGeometry(1.5, 1);
            mainObject = new THREE.Mesh(geometry, new THREE.MeshPhongMaterial({ color: 0xaaaaaa, shininess: 50 }));
            scene.add(mainObject);

            setupEventListeners();
            animate();
        }

        function setupEventListeners() {
            uiElements.joyBtn.addEventListener('click', () => selectEmotion(EMOTIONS.JOY, 'JOY'));
            uiElements.angerBtn.addEventListener('click', () => selectEmotion(EMOTIONS.ANGER, 'ANGER'));
            uiElements.sadBtn.addEventListener('click', () => selectEmotion(EMOTIONS.SAD, 'SAD'));
            uiElements.funBtn.addEventListener('click', () => selectEmotion(EMOTIONS.FUN, 'FUN'));
            window.addEventListener('resize', onWindowResize);
        }

        function selectEmotion(emotion, key) {
            currentEmotionKey = key;
            mainObject.material.color.set(emotion.color);
            uiElements.infoEmotion.textContent = emotion.name;
            updateArrowDisplay(emotion.color);
        }
        
        // 3つの数値を1つの整数にハッシュ化する簡易的な関数
        function hashVector3(vec) {
            const scale = 100;
            const offset = 1000;
            const x = Math.floor(vec.x * scale + offset);
            const y = Math.floor(vec.y * scale + offset);
            const z = Math.floor(vec.z * scale + offset);
            return x * 1000000 + y * 1000 + z;
        }

        function updateArrowDisplay(color) {
            const arrow = ARROWS[color];
            if (!arrow) return;
            const dots = uiElements.arrowDisplay.querySelector('.dots');
            dots.innerHTML = '';
            arrow.dots.forEach(dotColor => {
                const dotSpan = document.createElement('span');
                dotSpan.className = 'dot';
                dotSpan.style.backgroundColor = dotColor;
                dots.appendChild(dotSpan);
            });
            uiElements.arrowDisplay.querySelector('.arrow-symbol').textContent = arrow.symbol;
        }

        function updateInfoPanel() {
            const pos = camera.position;
            const azimuth = (Math.atan2(pos.x, pos.z) * (180 / Math.PI) + 360) % 360;
            uiElements.infoAngle.textContent = `${azimuth.toFixed(1)}°`;

            // JSONデータの生成と表示
            const jsonData = {
                value_1: currentEmotionKey ? EMOTIONS[currentEmotionKey].overtone : null,
                value_2: hashVector3(camera.position),
                value_3: hashVector3(camera.rotation.toVector3()) // 回転を簡易的にハッシュ化
            };
            uiElements.jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateInfoPanel();
            renderer.render(scene, camera);
        }
        
        init();
    </script>
</body>
</html>